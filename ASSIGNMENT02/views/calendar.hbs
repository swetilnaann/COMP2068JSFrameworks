{{!< layout}}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

<div class="container mt-4">
  <h2 class="text-center mb-4">ðŸ“… My Cycle Calendar</h2>
  <div id="calendar"></div>
</div>

<!-- ðŸŒ¸ Bootstrap Modal -->
<div class="modal fade" id="phaseModal" tabindex="-1" aria-labelledby="phaseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold" id="phaseModalLabel">Cycle Phase</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center fs-5" id="phaseInfo">
        <!-- Phase details will be shown here -->
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const calendarEl = document.getElementById("calendar");
    const modal = new bootstrap.Modal(document.getElementById("phaseModal"));
    const modalBody = document.getElementById("phaseInfo");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      selectable: true,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,dayGridWeek"
      },
      dateClick: function (info) {
        showPhase(info.dateStr);
      },
      events: [
        {{#each cycles}}
          {
            title: "ðŸ©¸ Period",
            start: "{{startDate}}",
            end: "{{endDate}}",
            color: "#ff6b81"
          },
        {{/each}}
      ]
    });

    calendar.render();

    // helper to decide phase + emoji from day of cycle
    function getPhase(cycleDay) {
      const periodLength = 5;   // days 1â€“5
      const cycleLength = 28;   // total cycle length

      if (cycleDay <= periodLength) {
        return { label: "Menstrual Phase", emoji: "ðŸ©¸" };
      } else if (cycleDay <= 14) {
        return { label: "Follicular Phase", emoji: "ðŸŒ±" };
      } else if (cycleDay === 15 || cycleDay === 16) {
        return { label: "Ovulation Phase", emoji: "ðŸ’§" };
      } else if (cycleDay <= cycleLength) {
        return { label: "Luteal Phase", emoji: "ðŸŒ™" };
      } else {
        return { label: "Outside tracked cycle", emoji: "â“" };
      }
    }

    // ðŸŒ¸ Function to calculate and show phase
    function showPhase(clickedDateStr) {
      const clickedDate = dayjs(clickedDateStr);
      let found = false;

      // 1) Check if the clicked date falls inside any logged period
      {{#each cycles}}
      {
        const periodStart = dayjs("{{startDate}}");
        const periodEnd = dayjs("{{endDate}}");

        if (
          clickedDate.isAfter(periodStart.subtract(1, "day")) &&
          clickedDate.isBefore(periodEnd.add(1, "day"))
        ) {
          const diff = clickedDate.diff(periodStart, "day") + 1; // day of this period
          const phaseInfo = getPhase(diff);

          modalBody.innerHTML = `
            <p>${phaseInfo.emoji} <strong>Day ${diff}</strong> of your cycle</p>
            <p><em>${phaseInfo.label}</em></p>
          `;
          modal.show();
          found = true;
        }
      }
      {{/each}}

      // 2) If not within a logged period: estimate based on last start date
      if (!found) {
        {{#if cycles.length}}
          const lastStart = dayjs("{{lastStartDate}}");
          let daysSince = clickedDate.diff(lastStart, "day") % 28;
          if (daysSince === 0) daysSince = 28; // avoid "Day 0"

          const phaseInfo = getPhase(daysSince);

          modalBody.innerHTML = `
            <p>${phaseInfo.emoji} <strong>${clickedDate.format("MMMM D, YYYY")}</strong></p>
            <p>Day ${daysSince} of your cycle</p>
            <p><em>${phaseInfo.label}</em></p>
          `;
          modal.show();
        {{else}}
          modalBody.innerHTML = `
            <p>No cycle data yet.</p>
            <p>Please <a href="/add-cycle">add your first period</a> to begin tracking.</p>
          `;
          modal.show();
        {{/if}}
      }
    }
  });
</script>
